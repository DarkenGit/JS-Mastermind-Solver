<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mastermind Solver</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  </head>
  <body>
    <div class="container my-4">
      <h2>Mastermind Solver (1â€“9, no duplicates, 3 pegs)</h2>
      <div class="mb-3">
        <button id="start" class="btn btn-primary">Start</button>
        <button id="reset" class="btn btn-secondary" style="display:none;">Reset</button>
      </div>

      <div id="input-alert" class="alert alert-danger" style="display:none;"></div>

      <!-- Current guess fixed position -->
      <div id="cur-guess"></div>
      <div id="cur-guess-alert" class="alert alert-danger" style="display:none;"></div>
      <div id="success" class="alert alert-success" style="display:none;">
        ðŸŽ‰ Solved! Click Reset to play again.
      </div>

      <hr>
      <h4>Guess History</h4>
      <table id="old-guesses-table" class="table table-striped table-hover" style="display:none;">
        <thead>
          <tr>
            <th>Guess</th>
            <th>@ (Right #, Right Place)</th>
            <th># (Right #, Wrong Place)</th>
            <th>Ignore</th>
          </tr>
        </thead>
        <tbody id="old-guesses"></tbody>
      </table>
    </div>

    <!-- Templates -->
    <script id="new-guess-template" type="text/x-handlebars-template">
      <div class="guess mb-2"><b>Is it maybe {{guess}}?</b></div>
      <div class="form-inline mb-2">
        <label class="mr-2">@:</label>
        <input type="number" min="0" step="1" max="{{numPegs}}" value="0" class="form-control bothCorrect mr-3" style="width:70px;">
        <label class="mr-2">#:</label>
        <input type="number" min="0" step="1" max="{{numPegs}}" value="0" class="form-control colorCorrect mr-3" style="width:70px;">
        <button class="btn btn-primary mr-2 next-btn">Next</button>
        <button class="btn btn-warning override-btn">Override Guess</button>
      </div>
    </script>

    <script id="old-guess-template" type="text/x-handlebars-template">
      <tr class="evidence">
        <td>{{guess}}</td>
        <td><input type="number" min="0" max="{{numPegs}}" value="{{bothCorrect}}" class="form-control form-control-sm bothCorrect-edit" style="width:60px;"></td>
        <td><input type="number" min="0" max="{{numPegs}}" value="{{colorCorrect}}" class="form-control form-control-sm colorCorrect-edit" style="width:60px;"></td>
        <td>
          <div class="form-check">
            <input type="checkbox" class="form-check-input ignore-row" id="ignore-{{index}}">
            <label class="form-check-label" for="ignore-{{index}}">Ignore</label>
          </div>
        </td>
      </tr>
    </script>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.1.2/handlebars.min.js"></script>
    <script>
      $(function(){
        const $startBtn=$("#start"),
              $resetBtn=$("#reset"),
              $oldGuessesTable=$("#old-guesses-table"),
              $playAreaOldGuesses=$("#old-guesses"),
              $playAreaCurGuess=$("#cur-guess"),
              $inputAlert=$("#input-alert"),
              $curGuessAlert=$("#cur-guess-alert"),
              $success=$("#success");

        const newGuessTemplate=Handlebars.compile($("#new-guess-template").html());
        const oldGuessTemplate=Handlebars.compile($("#old-guess-template").html());

        let globalGameState=null;

        function generateAllGuesses(numPegs,nums){
          if(numPegs===1) return nums.map(n=>[n]);
          let res=[];
          nums.forEach((n,i)=>{
            let rem=nums.slice(0,i).concat(nums.slice(i+1));
            generateAllGuesses(numPegs-1,rem).forEach(s=>res.push([n].concat(s)));
          });
          return res;
        }

        function judgeGuess(answer,guess){
          let both=0,color=0;
          let ansRem=[],gRem=[];
          for(let i=0;i<answer.length;i++){
            if(answer[i]===guess[i]) both++;
            else {ansRem.push(answer[i]); gRem.push(guess[i]);}
          }
          ansRem.forEach(a=>{
            let idx=gRem.indexOf(a);
            if(idx!==-1){color++; gRem.splice(idx,1);}
          });
          return {bothCorrect:both,colorCorrect:color};
        }

        function contradicts(guess,evidences){
          for(let e of evidences){
            let j=judgeGuess(guess,e.guess);
            if(j.bothCorrect!==e.bothCorrect||j.colorCorrect!==e.colorCorrect) return true;
          }
          return false;
        }

        function nextGuess(state,evidences){
          while(state.possibleGuesses.length){
            let idx=Math.floor(Math.random()*state.possibleGuesses.length);
            let g=state.possibleGuesses.splice(idx,1)[0];
            if(!contradicts(g,evidences)) return g;
          }
          return null;
        }

        function guessToString(g){return g.join("");}

        function collectEvidence(){
          let ev=[];
          $playAreaOldGuesses.find(".evidence").each((i,row)=>{
            let $row=$(row);
            if($row.find(".ignore-row").is(":checked")) return;
            let both=parseInt($row.find(".bothCorrect-edit").val());
            let color=parseInt($row.find(".colorCorrect-edit").val());
            ev.push({guess:$row.data("evidence").guess,bothCorrect:both,colorCorrect:color});
          });
          return ev;
        }

        function regenerateGuess(){
          let evidence=collectEvidence();
          globalGameState.possibleGuesses=generateAllGuesses(globalGameState.numPegs,globalGameState.colors);
          let g=nextGuess(globalGameState,evidence);

          $curGuessAlert.hide(); $success.hide();
          if(!g){
            $playAreaCurGuess.hide();
            $curGuessAlert.text("No possible solutions. Check feedback or ignore rows.").show();
          }else{
            $playAreaCurGuess.html(newGuessTemplate({guess:guessToString(g),numPegs:globalGameState.numPegs}));
            $playAreaCurGuess.find(".guess").data("guess",g);
            $playAreaCurGuess.show();
          }
        }

        function commitGuess(){
          if($playAreaCurGuess.find("input").length===0) return;
          let both=parseInt($playAreaCurGuess.find(".bothCorrect").val());
          let color=parseInt($playAreaCurGuess.find(".colorCorrect").val());
          if(both+color>globalGameState.numPegs){
            $curGuessAlert.text("Invalid feedback: sum exceeds pegs.").show();
            return;
          }
          if(both===globalGameState.numPegs){$success.show(); return;}

          $oldGuessesTable.show();
          let g=$playAreaCurGuess.find(".guess").data("guess");
          let $row=$(oldGuessTemplate({
            guess:guessToString(g),
            bothCorrect:both,
            colorCorrect:color,
            numPegs:globalGameState.numPegs,
            index:$playAreaOldGuesses.find(".evidence").length
          }));
          $row.data("evidence",{guess:g,bothCorrect:both,colorCorrect:color});
          $playAreaOldGuesses.append($row);

          regenerateGuess();
        }

        $startBtn.on("click",()=>{
          $playAreaOldGuesses.html(""); $playAreaCurGuess.html("");
          $inputAlert.hide(); $curGuessAlert.hide(); $success.hide();
          let numPegs=3;
          let nums=["1","2","3","4","5","6","7","8","9"];
          if(nums.length<numPegs){$inputAlert.text("Not enough digits.").show();return;}
          let possible=generateAllGuesses(numPegs,nums);
          globalGameState={numPegs,colors:nums,allowDups:false,possibleGuesses:possible};
          $startBtn.hide(); $resetBtn.show();
          regenerateGuess();
        });

        $resetBtn.on("click",()=>{
          $playAreaOldGuesses.empty(); $playAreaCurGuess.empty();
          $oldGuessesTable.hide(); $curGuessAlert.hide(); $success.hide();
          $startBtn.show(); $resetBtn.hide();
        });

        $playAreaCurGuess.on("click",".next-btn",()=>commitGuess());
        $playAreaCurGuess.on("click",".override-btn",()=>{
          let val=prompt("Enter your override guess (e.g., 123):");
          if(val && val.length===globalGameState.numPegs){
            let g=val.split("");
            $playAreaCurGuess.find(".guess").data("guess",g).html("<b>Is it maybe "+guessToString(g)+"?</b>");
          }
        });

        $playAreaOldGuesses.on("change","input,checkbox",()=>regenerateGuess());
      });
    </script>
  </body>
</html>
