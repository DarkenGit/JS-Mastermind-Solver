<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <title>Mastermind Solver (1â€“9)</title>
</head>
<body>
<div class="container mt-4">
  <h2>Mastermind Solver (Digits 1â€“9, no duplicates, 3 pegs)</h2>

  <div class="mb-3">
    <button id="start" class="btn btn-primary">Start</button>
    <button id="reset" class="btn btn-danger" style="display:none;">Reset</button>
  </div>

  <div id="play-area">
    <table id="old-guesses-table" class="table table-striped table-hover" style="display:none;">
      <thead>
        <tr>
          <th>Guess</th><th>@</th><th>#</th><th>Ignore</th>
        </tr>
      </thead>
      <tbody id="old-guesses"></tbody>
    </table>

    <div id="cur-guess"></div>

    <div id="cur-guess-alert" class="alert alert-danger" style="display:none"></div>
    <div id="success" class="alert alert-success" style="display:none">
      ðŸŽ‰ Correct! Click "Reset" to try again.
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.1.2/handlebars.min.js"></script>

<!-- Templates -->
<script id="new-guess-template" type="text/x-handlebars-template">
  <div class="guess mb-2">Is it maybe <b>{{guess}}</b>?</div>
  <div class="form-inline mb-2">
    <label class="mr-2">@:</label>
    <input type="number" min="0" max="{{numPegs}}" value="0" class="form-control bothCorrect mr-3" style="width:70px;">
    <label class="mr-2">#:</label>
    <input type="number" min="0" max="{{numPegs}}" value="0" class="form-control colorCorrect mr-3" style="width:70px;">
    <button class="btn btn-primary mr-2 next-btn">Next</button>
    <input type="text" class="form-control override-input mr-2" placeholder="Override guess e.g. 123" style="width:120px;">
    <button class="btn btn-warning override-btn">Override</button>
  </div>
</script>

<script id="old-guess-template" type="text/x-handlebars-template">
  <tr class="evidence">
    <td>{{guess}}</td>
    <td><input type="number" min="0" max="{{numPegs}}" value="{{bothCorrect}}" class="form-control form-control-sm bothCorrect-edit" style="width:60px;"></td>
    <td><input type="number" min="0" max="{{numPegs}}" value="{{colorCorrect}}" class="form-control form-control-sm colorCorrect-edit" style="width:60px;"></td>
    <td>
      <div class="form-check">
        <input type="checkbox" class="form-check-input ignore-row" id="ignore-{{index}}">
        <label class="form-check-label" for="ignore-{{index}}">Ignore</label>
      </div>
    </td>
  </tr>
</script>

<script>
$(function(){
  const numPegs = 3;
  const digits = ["1","2","3","4","5","6","7","8","9"];

  var $startBtn = $('#start');
  var $resetBtn = $('#reset');
  var $oldGuessesTable = $('#old-guesses-table');
  var $playAreaOldGuesses = $('#old-guesses');
  var $playAreaCurGuess = $('#cur-guess');
  var $curGuessAlert = $('#cur-guess-alert');
  var $success = $('#success');

  var newGuessTemplate = Handlebars.compile($('#new-guess-template').html());
  var oldGuessTemplate = Handlebars.compile($('#old-guess-template').html());

  var globalGameState = null;

  // Generate all guesses (no duplicates)
  function generateAllGuesses(pegs, numbers) {
    if (pegs === 1) return numbers.map(d => [d]);
    let result = [];
    numbers.forEach((n,i)=>{
      let remaining = numbers.slice(0,i).concat(numbers.slice(i+1));
      generateAllGuesses(pegs-1,remaining).forEach(suf=>{
        result.push([n].concat(suf));
      });
    });
    return result;
  }

  function judgeGuess(answer, guess){
    let res = {bothCorrect:0, colorCorrect:0};
    let unAns=[], unGuess=[];
    for(let i=0;i<answer.length;i++){
      if(answer[i]===guess[i]) res.bothCorrect++;
      else { unAns.push(answer[i]); unGuess.push(guess[i]); }
    }
    unAns.forEach(a=>{
      let idx=unGuess.indexOf(a);
      if(idx!==-1){ res.colorCorrect++; unGuess.splice(idx,1);}
    });
    return res;
  }

  function guessContradictsEvidence(guess,evidences){
    for(let ev of evidences){
      let j=judgeGuess(guess,ev.guess);
      if(j.bothCorrect!==ev.bothCorrect || j.colorCorrect!==ev.colorCorrect) return true;
    }
    return false;
  }

  function nextGuess(gameState,evidence){
    while(gameState.possibleGuesses.length>0){
      let idx=Math.floor(Math.random()*gameState.possibleGuesses.length);
      let guess=gameState.possibleGuesses.splice(idx,1)[0];
      if(!guessContradictsEvidence(guess,evidence)) return guess;
    }
    return null;
  }

  function guessToString(guess){ return guess.join(""); }

  function regenerateGuessFromEvidence(){
    let evidence=[];
    $playAreaOldGuesses.find('.evidence').each((i,row)=>{
      let $row=$(row);
      if($row.find('.ignore-row').is(':checked')) return;
      evidence.push({
        guess:$row.data('evidence').guess,
        bothCorrect:parseInt($row.find('.bothCorrect-edit').val()),
        colorCorrect:parseInt($row.find('.colorCorrect-edit').val())
      });
    });

    globalGameState.possibleGuesses = generateAllGuesses(globalGameState.numPegs, globalGameState.colors);
    let newGuess=nextGuess(globalGameState,evidence);

    $curGuessAlert.hide(); $success.hide();
    if(!newGuess){
      $playAreaCurGuess.hide();
      $curGuessAlert.text("No possible solutions. Check your feedback or ignore some rows.").show();
    }else{
      $playAreaCurGuess.html(newGuessTemplate({guess:guessToString(newGuess),numPegs:globalGameState.numPegs}));
      $playAreaCurGuess.find('.guess').data('guess',newGuess);
      $playAreaCurGuess.show();
    }
  }

  function lockInGuess(){
    $curGuessAlert.hide(); $success.hide();
    if($playAreaCurGuess.find('input').length===0) return;

    let both=parseInt($playAreaCurGuess.find('.bothCorrect').val());
    let color=parseInt($playAreaCurGuess.find('.colorCorrect').val());
    if(both+color>globalGameState.numPegs){
      $curGuessAlert.text("Invalid feedback: @ + # > number of pegs").show(); return;
    }
    if(both===globalGameState.numPegs){ $success.show(); return; }

    $oldGuessesTable.show();
    let guess=$playAreaCurGuess.find('.guess').data('guess');
    let $row=$(oldGuessTemplate({
      guess:guessToString(guess),
      bothCorrect:both,colorCorrect:color,numPegs:globalGameState.numPegs,
      index:$playAreaOldGuesses.find('.evidence').length
    }));
    $row.data('evidence',{guess:guess,bothCorrect:both,colorCorrect:color});
    $playAreaOldGuesses.append($row);

    regenerateGuessFromEvidence();
  }

  // --- Events ---
  $startBtn.on('click',()=>{
    globalGameState={
      numPegs:numPegs,
      colors:digits,
      possibleGuesses:generateAllGuesses(numPegs,digits)
    };
    $playAreaOldGuesses.empty(); $playAreaCurGuess.empty();
    $oldGuessesTable.hide(); $curGuessAlert.hide(); $success.hide();
    $startBtn.hide(); $resetBtn.show();
    regenerateGuessFromEvidence();
  });

  $resetBtn.on('click',()=>{
    globalGameState=null;
    $playAreaOldGuesses.empty(); $playAreaCurGuess.empty();
    $oldGuessesTable.hide(); $curGuessAlert.hide(); $success.hide();
    $startBtn.show().text("Start"); $resetBtn.hide();
  });

  $playAreaCurGuess.on('click','.next-btn',lockInGuess);

  // Override current guess
  $playAreaCurGuess.on('click','.override-btn',function(){
    let val=$playAreaCurGuess.find('.override-input').val().trim();
    if(val.length!==numPegs || !/^[1-9]+$/.test(val)) { alert("Enter "+numPegs+" unique digits (1â€“9)"); return; }
    let arr=val.split("");
    if(new Set(arr).size!==numPegs){ alert("No duplicates allowed"); return; }
    $playAreaCurGuess.find('.guess').html("Is it maybe <b>"+val+"</b>?").data('guess',arr);
  });

  // When old guess rows are changed, recalc
  $playAreaOldGuesses.on('change','input,checkbox',regenerateGuessFromEvidence);
});
</script>
</body>
</html>
